@page "/virtual-bunko"
@inject IJSRuntime JSRuntime
@inject ISnackbar Snackbar
@using System.IO

<PageTitle>Virtual Bunko Press</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4 cyber-font" Color="Color.Primary">Virtual Bunko Press (vNative-3D)</MudText>

<MudGrid>
    <!-- Editor Column -->
    <MudItem xs="12" md="5">
        <MudPaper Elevation="3" Class="pa-4">
            <MudText Typo="Typo.h6" Class="mb-4">Editor</MudText>

            <!-- 1. Background Image -->
            <MudText Typo="Typo.subtitle2" Color="Color.Primary" Class="mt-4">1. Cover Illustration</MudText>
            <MudFileUpload T="IBrowserFile" FilesChanged="OnImageUpload" Accept=".png, .jpg, .jpeg">
                <ButtonTemplate>
                    <MudButton HtmlTag="label"
                               Variant="Variant.Filled"
                               Color="Color.Primary"
                               StartIcon="@Icons.Material.Filled.Image"
                               FullWidth="true"
                               for="@context">
                        Select Image
                    </MudButton>
                </ButtonTemplate>
            </MudFileUpload>

            <MudDivider Class="my-4" />

            <!-- 2. Title Settings -->
            <MudText Typo="Typo.subtitle2" Color="Color.Info" Class="mt-4">2. Title Settings</MudText>
            <MudTextField @bind-Value="TitleText" Label="Title" Variant="Variant.Outlined" Lines="2" />
            
            <MudGrid Class="mt-2">
                <MudItem xs="6">
                    <div style="margin-bottom: 8px;">
                        <label style="font-size: 0.8rem; color: #94a3b8; display: block; margin-bottom: 4px;">Font</label>
                        <select @bind="SelectedFont" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #475569; background: #1e293b; color: white;">
                             <option value="Shippori Mincho">Mincho (Fantasy)</option>
                             <option value="Mochiy Pop One">Pop (LoveCom)</option>
                        </select>
                    </div>
                </MudItem>
                <MudItem xs="6">
                    <div style="margin-bottom: 8px;">
                        <label style="font-size: 0.8rem; color: #94a3b8; display: block; margin-bottom: 4px;">Effect Preset</label>
                        <select @bind="SelectedPresetId" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #475569; background: #1e293b; color: white;">
                            @foreach (var p in TitlePresets)
                            {
                                <option value="@p.Id">@p.Name</option>
                            }
                        </select>
                    </div>
                </MudItem>
                <MudItem xs="6">
                    <div style="margin-bottom: 8px;">
                        <label style="font-size: 0.8rem; color: #94a3b8; display: block; margin-bottom: 4px;">Effect Preset</label>
                        <select @bind="SelectedPresetId" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #475569; background: #1e293b; color: white;">
                            @foreach (var p in TitlePresets)
                            {
                                <option value="@p.Id">@p.Name</option>
                            }
                        </select>
                    </div>
                </MudItem>
            </MudGrid>

            <!-- 3D Mode Toggle -->
             <div class="d-flex align-center justify-space-between mt-4 mb-2 pa-2 rounded" style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);">
                <MudText Typo="Typo.body2">3D Mockup Mode</MudText>
                <MudSwitch @bind-Checked="Is3DMode" Color="Color.Secondary" Label="Preview" />
            </div>

            <MudGrid>
                <MudItem xs="6">
                    <div style="margin-bottom: 8px;">
                        <label style="font-size: 0.8rem; color: #94a3b8; display: block; margin-bottom: 4px;">Text Color</label>
                        <div style="display: flex; align-items: center; border: 1px solid #475569; border-radius: 4px; padding: 4px; background: #1e293b;">
                            <input type="color" @bind="TitleColor" style="width: 100%; height: 30px; border: none; background: transparent; cursor: pointer;" />
                        </div>
                    </div>
                </MudItem>
                <MudItem xs="6">
                     <div style="margin-bottom: 8px;">
                        <label style="font-size: 0.8rem; color: #94a3b8; display: block; margin-bottom: 4px;">Outline Color</label>
                        <div style="display: flex; align-items: center; border: 1px solid #475569; border-radius: 4px; padding: 4px; background: #1e293b;">
                            <input type="color" @bind="TitleOutlineColor" style="width: 100%; height: 30px; border: none; background: transparent; cursor: pointer;" />
                        </div>
                    </div>
                </MudItem>
            </MudGrid>
            
            <MudSlider @bind-Value="TitleSize" Min="1.0" Max="5.0" Step="0.1" Color="Color.Info" Class="mt-2">Size: @TitleSize rem</MudSlider>
            <MudSlider @bind-Value="TitleX" Min="0" Max="100" Step="1" Color="Color.Info">X: @TitleX %</MudSlider>
            <MudSlider @bind-Value="TitleY" Min="0" Max="100" Step="1" Color="Color.Info">Y: @TitleY %</MudSlider>

            <MudDivider Class="my-4" />

            <!-- 3. Logo Settings -->
            <MudText Typo="Typo.subtitle2" Color="Color.Secondary" Class="mt-4">3. Bunko Label</MudText>
            <div style="margin-bottom: 8px;">
                 <label style="font-size: 0.8rem; color: #94a3b8; display: block; margin-bottom: 4px;">Label</label>
                 <select @bind="SelectedLabel" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #475569; background: #1e293b; color: white;">
                      <option Value="GENKAI Bunko">GENKAI Bunko (限界文庫)</option>
                      <option Value="CYBER Sneaker">CYBER Sneaker (電脳スニーカー)</option>
                      <option Value="Phantom Novel">Phantom Novel (幻影ノベル)</option>
                 </select>
            </div>

            <MudDivider Class="my-4" />

            <!-- 4. Obi Settings -->
            <MudText Typo="Typo.subtitle2" Color="Color.Warning" Class="mt-4">4. Obi (Band)</MudText>
            <MudSwitch @bind-Value="ShowObi" Color="Color.Success">Show Obi</MudSwitch>
            
            @if(ShowObi)
            {
                <MudTextField @bind-Value="ObiMainText" Label="Catchphrase (Main)" Variant="Variant.Outlined" Class="mt-2" />
                <MudTextField @bind-Value="ObiSubText" Label="Sub Text" Variant="Variant.Outlined" Class="mt-2" />
                <div style="margin-bottom: 8px;" class="mt-2">
                    <label style="font-size: 0.8rem; color: #94a3b8; display: block; margin-bottom: 4px;">Color</label>
                    <select @bind="ObiColor" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #475569; background: #1e293b; color: white;">
                        <option Value="radial-gradient(circle, rgba(238,174,202,1) 0%, rgba(148,187,233,1) 100%)">Pastel Gradient</option>
                        <option Value="#ef4444">Burning Red</option>
                        <option Value="#eab308">Lightning Yellow</option>
                        <option Value="#3b82f6">Cyber Blue</option>
                        <option Value="#000000">Abyss Black</option>
                    </select>
                </div>
            }
             <MudDivider Class="my-4" />
             <!-- 5. Author -->
             <MudText Typo="Typo.subtitle2" Class="mt-4">5. Author Name</MudText>
             <MudTextField @bind-Value="AuthorName" Label="Author" Variant="Variant.Outlined" />

            <MudDivider Class="my-4" />

            <MudButton Variant="Variant.Filled" Color="Color.Success" FullWidth="true" OnClick="ExportImage" StartIcon="@Icons.Material.Filled.Save" Class="py-3">
                Publish (Save Image)
            </MudButton>

        </MudPaper>
    </MudItem>

    <!-- Preview Column -->
    <MudItem xs="12" md="7" Class="d-flex justify-center align-start bg-dark pa-4" Style="min-height: 600px;">
        <!-- Book Scene (3D) -->
        <div class="book-scene">
            <div class="@($"book {(Is3DMode ? "is-3d" : "")}")">
                 <!-- SPINE -->
                <div class="book-spine" style="@GetSpineStyle()"></div>
                
                <!-- PAGE EDGES -->
                <div class="book-page-edges"></div>
                
                <!-- FRONT FACE -->
                <div class="book-face-front">
                    <!-- Original Wrapper (Target for Capture) -->
                    <div class="book-wrapper" id="bunko-preview">
                         <div class="book-cover">
                             <!-- Background Image -->
                             @if (!string.IsNullOrEmpty(BgImageData))
                             {
                                 <img src="@BgImageData" class="cover-image" />
                             }
                             else
                             {
                                 <div class="cover-placeholder d-flex align-center justify-center">
                                     <MudIcon Icon="@Icons.Material.Filled.Image" Size="Size.Large" Color="Color.Dark" />
                                 </div>
                             }
            
                             <!-- Logo -->
                             <div class="logo-area @GetLogoClass()">
                                 <div class="logo-text">@SelectedLabel</div>
                             </div>
            
                             <!-- Title -->
                             <div class="title-area @GetTitleClass()" style="@GetTitleStyle()">
                                 @TitleText
                             </div>
            
                             <!-- Author -->
                              <div class="author-area">
                                 @AuthorName
                             </div>
            
                             <!-- Obi -->
                             @if (ShowObi)
                             {
                                 <div class="obi-area" style="background: @ObiColor;">
                                     <div class="obi-main">@ObiMainText</div>
                                     <div class="obi-sub">@ObiSubText</div>
                                 </div>
                             }
                         </div>
                    </div>
                </div>
            </div>
        </div>
    </MudItem>
</MudGrid>

<link href="Pages/VirtualBunko.razor.css" rel="stylesheet" />

<style>
    /* Moved complex styles to VirtualBunko.razor.css */
    /* Retaining only basic layout/color overrides if needed */
    .bg-dark { background-color: #0f172a; }
    .cyber-font { font-family: 'Orbitron', sans-serif; }
</style>

@code {
    private string BgImageData = "";
    private string TitleText = "転生したら\n限界SEだった件";
    private string SelectedFont = "Shippori Mincho";
    private string TitleColor = "#ffffff";
    private string TitleOutlineColor = "#000000";
    private double TitleSize = 2.5;
    private double TitleX = 80; // Right aligned
    private double TitleY = 15;
    
    private string SelectedLabel = "GENKAI Bunko";
    
    private bool ShowObi = true;
    private string ObiMainText = "「定時退社は都市伝説!?」";
    private string ObiSubText = "全米が泣いた(デバッグで)";
    private string ObiColor = "radial-gradient(circle, rgba(238,174,202,1) 0%, rgba(148,187,233,1) 100%)";
    
    private string AuthorName = "著: 迷える子羊 / Illust: AI";

    // 3D & Preset Logic
    private bool Is3DMode = false;
    private string SelectedPresetId = "standard";

    public class TitlePreset
    {
        public string Id { get; set; }
        public string Name { get; set; }
        public string CssClass { get; set; }
    }

    private List<TitlePreset> TitlePresets = new List<TitlePreset>
    {
        new TitlePreset { Id = "standard", Name = "Standard (No Effect)", CssClass = "" },
        new TitlePreset { Id = "neon", Name = "Demon Neon (Cyber)", CssClass = "tx-neon" },
        new TitlePreset { Id = "gold", Name = "Isekai Gold (Luxury)", CssClass = "tx-gold" },
        new TitlePreset { Id = "glitch", Name = "System Error (Glitch)", CssClass = "tx-glitch" },
        new TitlePreset { Id = "romance", Name = "Sweet Romance (Soft)", CssClass = "tx-romance" },
        new TitlePreset { Id = "impact", Name = "Shonen Impact (Bold)", CssClass = "tx-impact" }
    };

    private void UseSnackbar(string msg)
    {
        Snackbar.Add(msg, Severity.Error);
    }

    private async Task OnImageUpload(IBrowserFile file)
    {
        if (file.Size > 10 * 1024 * 1024) return;
        using var stream = file.OpenReadStream(10 * 1024 * 1024);
        using var ms = new MemoryStream();
        await stream.CopyToAsync(ms);
        var base64 = Convert.ToBase64String(ms.ToArray());
        BgImageData = $"data:{file.ContentType};base64,{base64}";
    }

    private string GetLogoClass()
    {
        return SelectedLabel switch
        {
            "GENKAI Bunko" => "genkai",
            "CYBER Sneaker" => "sneaker",
            "Phantom Novel" => "phantom",
            _ => ""
        };
    }

    private string GetTitleClass()
    {
        var preset = TitlePresets.FirstOrDefault(p => p.Id == SelectedPresetId);
        return $"{preset?.CssClass ?? ""}";
    }

    private string GetTitleStyle()
    {
        // Colors from picker are only used if preset doesn't override complexity, 
        // but generally we keep them active so user can combine "Gold" with "Blue" color etc.
        var strokeStyle = $"-webkit-text-stroke: 1px {TitleOutlineColor}; text-shadow: 2px 2px 0 {TitleOutlineColor};";
        
        // If Preset is Neon/Gold, we might want to suppress the default text stroke or blending.
        // For now, let's append.
        return $"font-family: '{SelectedFont}', serif; color: {TitleColor}; font-size: {TitleSize}rem; right: {100 - TitleX}%; top: {TitleY}%; {strokeStyle}";
    }

    private string GetSpineStyle()
    {
        // Heuristic: Use obi color for spine if it's solid, else grey
         if (ObiColor.StartsWith("#")) return $"background: {ObiColor};";
        return "background: #eee;";
    }

    private async Task ExportImage()
    {
        bool was3D = Is3DMode;
        if (was3D)
        {
            Is3DMode = false;
            StateHasChanged();
            await Task.Delay(150); // Wait for transition
        }
        
        try {
            await JSRuntime.InvokeVoidAsync("downloadCard", "bunko-preview", "virtual-bunko-cover.png");
        }
        finally
        {
            if (was3D)
            {
                Is3DMode = true;
                StateHasChanged();
            }
        }
    }
}
